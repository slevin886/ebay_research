{% extends 'base.html' %}

{% block content %}
{% if form.errors %}
<ul class=errors>
{% for name, error in form.errors.items() %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <span>Problem with {{ name }}: {{ error[0] }}. Try your search again.</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
{% endfor %}
</ul>
{% endif %}
<div class="row mt-3">
    <div class="col">
        <hr>
        <h3 class="page_header">search</h3>
        <h5>choose your search criteria</h5>
    </div>
</div>
<div class="row">
    <div class="col">
        <form method="POST" action="{{ url_for('main.basic_search') }}">
            {{ form.csrf_token }}
            <div class="row mt-3">
                <div class="col-4">
                    <div class="form-group">
                        <label><strong>Keywords to include<span style="color: red; vertical-align: top; font-size: 10px;">âœ±</span>:</strong></label>
                        {{ form.keywords_include(class="form-control", placeholder="Enter Keywords") }}</div>
                    <div class="form-group"><strong>{{ form.keywords_exclude.label }}</strong>
                        {{ form.keywords_exclude(class="form-control", placeholder="optional") }}</div>
                </div>
                <!--MIN & MAX PRICE-->
                <div class="col">
                    <div class="form-group"><strong>{{ form.maximum_price.label }}</strong>
                        {{ form.maximum_price(class="form-control", placeholder="optional") }}</div>
                    <div class="form-group"><strong>{{ form.minimum_price.label }}</strong>
                        {{ form.minimum_price(class="form-control", placeholder="optional") }}</div>
                </div>
                <!--Sort Order of Results-->
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label><strong>Sort Results by:</strong></label>
                            <select class="form-control" id="item_sort" name="item_sort">
                                <option value="BestMatch">Best Match</option>
                                <option value="CurrentPriceHighest">Highest Price First</option>
                                <option value="BidCountMost"> Highest Bid Count</option>
                                <option value="BidCountFewest">Bid Count Fewest</option>
                                <option value="EndTimeSoonest">End Time Soonest</option>
                                <option value="StartTimeNewest">Start Time Newest</option>
                                <option value="WatchCountDecreaseSort">Highest Watch Count</option>
                            </select>
                        </div>
                    </div>
                    <!--Listing TYPE-->
                    <div class="row mt-3">
                        <div class="col">
                            <label for="listing_type"><strong>Listing Type:</strong></label>
                            <select class="form-control" id="listing_type" name="listing_type">
                                <option value="" selected>All Listing Types</option>
                                <option value="Auction">Auction</option>
                                <option value="StoreInventory">Store Inventory</option>
                                <option value="FixedPrice">Fixed Price</option>
                                <option value="AuctionWithBIN">Auction (w/ Buy Now)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!--SELLER LOCATION-->
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label for="condition"><strong>Item Condition:</strong></label>
                            <select class="form-control" id="condition" name="condition">
                                <option value="" selected>All Conditions</option>
                                <option value="1000">New</option>
                                <option value="Unspecified">Unspecified</option>
                                <option value="1750">New (w/ defects)</option>
                                <option value="2000">Manufacturer Refurbished</option>
                                <option value="2500">Seller Refurbished</option>
                                <option value="3000">Used</option>
                                <option value="4000">Very Good</option>
                                <option value="5000">Good</option>
                                <option value="6000">Acceptable</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <button type="submit" class="btn btn-success btn-lg page_button">Get Item Data!</button>
                </div>
            </div>
        </form>
    </div>
</div>
<hr>
{% if tab_data %}
<div class="row mt-3">
    <div class="col">
        <h3 class="page_header">Result Summary</h3>
    </div>
</div>
<div class="row mt-3">
    <div class="col">
        <img src="{{ url_for('static', filename='icons/item_img.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Items in Search: <strong>{{ stats['returned_count'] }}</strong></p>
        <img src="{{ url_for('static', filename='icons/item_img.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Total Items Available: <strong>{{ stats['total_entries'] }}</strong></p>
        <img src="{{ url_for('static', filename='icons/top_rated.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>% Items w/ Top Rated Listing: <strong>{{ stats['top_rated_listing'] }}%</strong></p>
        {%  if 'largest_cat_name' in stats.keys() %}
        <img src="{{ url_for('static', filename='icons/categories.png') }}" class="img-fluid" alt="Responsive image"
             style="width:20px;float:left;margin-right:5px;margin-top:4px;">
        <p>Largest Category: <strong>{{ stats['largest_cat_name'] }}
            ({{ stats['largest_cat_count'] }} items)</strong></p>
        {% endif %}
    </div>
    <div class="col">
        <img src="{{ url_for('static', filename='icons/seller_icon.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Top Seller: <strong>{{ stats['top_seller'] }}</strong></p>
        <img src="{{ url_for('static', filename='icons/seller_icon.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Top Seller Item Count: <strong>{{ stats['top_seller_count'] }}</strong></p>
        <img src="{{ url_for('static', filename='icons/top_rated.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>% Items from Top Rated Seller: <strong>{{ stats['top_rated_percent'] }}%</strong></p>
        {%  if 'largest_sub_name' in stats.keys() %}
        <img src="{{ url_for('static', filename='icons/categories.png') }}" class="img-fluid" alt="Responsive image"
             style="width:20px;float:left;margin-right:5px;margin-top:4px;">
        <p>Largest Subcategory: <strong>{{ stats['largest_sub_name'] }}
            ({{ stats['largest_sub_count'] }} items)</strong></p>
        {% endif %}
    </div>
    <div class="col">
        <img src="{{ url_for('static', filename='icons/avg_price.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Average price of items: <strong>${{ stats['avg_price'] }}</strong></p>
        <img src="{{ url_for('static', filename='icons/avg_price.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Median price of items: <strong>${{ stats['median_price'] }}</strong></p>
        <img src="{{ url_for('static', filename='icons/avg_price.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Average shipping price: <strong>${{ stats['avg_shipping_price'] }}</strong></p>
        <img src="{{ url_for('static', filename='icons/binoculars.png') }}" class="img-fluid" alt="Responsive image"
            style="width:20px;float:left;margin-right:5px;">
        <p>Total Watch Count: <strong>{{ stats['total_watch_count'] }}</strong></p>

    </div>
</div>
<div class="row">
    <div class="col-4">
        <a class="btn btn-success page_button" href="{{ url_for('main.get_csv') }}">Download the Full Dataset</a>
        <p class="mt-2">
            <a href="{{ page_url }}" target="_blank" style="color: red;">click here</a> to see the results on ebay
        </p>
    </div>
</div>
<hr>
<div class="row mt-3">
    <div class="col">
        <h3 class="page_header">dashboard</h3>
    </div>
</div>
<div class="row mt-3">
    <div class="col">
        <h5>price distribution</h5>
        <hr>
        <div id="histData" class="d-flex justify-content-center"></div>
    </div>
    <div class="col">
        <h5>price distribution (by listing type)</h5>
        <hr>
        <div id="dfTypePlot" class="d-flex justify-content-center"></div>
    </div>
</div>
<div class="row mt-3">
    <div class="col">
        <h5>seller locations by county</h5>
        <hr>
        <div id="usaMAP" class="d-flex justify-content-center"></div>
    </div>
    <div class="col">
        <h5>items by listing type</h5>
        <hr>
        <div id="dfPie" class="d-flex justify-content-center"></div>
    </div>
</div>
<div class="row mt-3">
    <div class="col">
        <h5>largest sellers</h5>
        <hr>
        <div id="sellerBar" class="d-flex justify-content-center"></div>
    </div>
    {% if make_sunburst %}
    <div class="col">
        <h5>listed item characteristics</h5>
        <hr>
        <div id="sunBurst" class="d-flex justify-content-center"></div>
        <p class="text-center">click the inside labels of the pie to enlarge each aspect</p>
        <script>var make_sunburst = {{ make_sunburst|tojson }};</script>
        <script src="{{ url_for('static', filename='basic_search/sunburst_plot.js') }}"></script>
    </div>
    {% endif %}
</div>
<div class="row mt-3">
    <div class="col">
        <hr>
        <h3 class="page_header">popular items</h3>
        <h5>sorted by <strong>highest watch count</strong></h5>
    </div>
</div>
<div class="row mt-3">
    <div class="col">
        <div id="tab_location"></div>
    </div>
</div>

<!--TODO: change 'df' to more descriptive name-->
<script>var df_type = {{ df_type|tojson }};
        var df_hist = {{ hist_plot|tojson }};
        var df = {{ map_plot|tojson }};
        var tab_data = {{ tab_data | tojson }};
        var df_pie = {{ df_pie | tojson }};
        var df_seller = {{ df_seller | tojson }};
</script>
<script src="{{ url_for('static', filename='basic_search/tabulate_script.js') }}"></script>
<script src="{{ url_for('static', filename='basic_search/basic_plots.js') }}"></script>
{% endif %}

{% endblock %}